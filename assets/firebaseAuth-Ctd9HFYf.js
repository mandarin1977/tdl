import{a as r,g as u,h,o as f}from"./index-DeMz8YVu.js";const g=(t,e)=>({id:t.uid,email:t.email,name:t.displayName||t.email?.split("@")[0]||"사용자",photoURL:t.photoURL,gameData:e||{level:1,coins:0,totalCoin:0,catFragments:50,nftCount:0,miningCats:[null,null,null,null],huntingCats:[null,null,null,null],explorationCats:[null,null,null,null],productionCats:[null,null,null,null],inventory:[]}});let c=!1,d=null;const S=async()=>{if(!r)return console.error("handleGoogleRedirect: Firebase Auth가 초기화되지 않았습니다."),{success:!1,error:"Firebase가 설정되지 않았습니다."};if(console.log("handleGoogleRedirect: 시작",{hasAuth:!!r,currentUser:r.currentUser?r.currentUser.email:"null",googleRedirectHandled:c,hasProcessingPromise:!!d}),d)return console.log("handleGoogleRedirect: 이미 처리 중, Promise 대기..."),d;if(c){console.log("handleGoogleRedirect: 이미 처리됨, 저장소 확인 중...");let t=null;try{const e=localStorage.getItem("currentUser");e&&(t=JSON.parse(e))}catch(e){console.error("localStorage 파싱 오류:",e)}if(!t)try{const e=sessionStorage.getItem("currentUser");e&&(t=JSON.parse(e))}catch(e){console.error("sessionStorage 파싱 오류:",e)}if(t&&t.id)return console.log("handleGoogleRedirect: 저장소에서 사용자 발견:",t.email),{success:!0,user:t};if(r&&r.currentUser)try{console.log("handleGoogleRedirect: 저장소 없지만 Firebase 인증 상태 있음, 복구 시도...");const e=r.currentUser,o=await u(e.uid),s=g(e,o?.gameData);return localStorage.setItem("currentUser",JSON.stringify(s)),sessionStorage.setItem("currentUser",JSON.stringify(s)),console.log("handleGoogleRedirect: 세션 복구 완료:",s.email),{success:!0,user:s}}catch(e){console.error("handleGoogleRedirect: 세션 복구 오류:",e)}return console.log("handleGoogleRedirect: 이미 처리됨, 하지만 사용자 없음"),{success:!1,error:"이미 처리됨"}}return d=(async()=>{try{if(console.log("handleGoogleRedirect: 처리 시작"),r&&r.currentUser){console.log("handleGoogleRedirect: Firebase 인증 상태 발견 (즉시):",r.currentUser.email),c=!0;const e=r.currentUser,o=await u(e.uid),s=g(e,o?.gameData);return localStorage.setItem("currentUser",JSON.stringify(s)),sessionStorage.setItem("currentUser",JSON.stringify(s)),console.log("handleGoogleRedirect: Firebase 인증 상태 확인 - 사용자 저장됨:",s.email),{success:!0,user:s}}console.log("handleGoogleRedirect: 리다이렉트 결과 확인 시도...");const t=await h();if(console.log("handleGoogleRedirect: handleRedirectResult 결과:",{success:t.success,hasUser:!!t.user,userEmail:t.user?.email||"없음",error:t.error||"없음"}),t&&t.success&&t.user){c=!0;const e=t.user;if(!e.uid&&e.id){const l=e;return localStorage.setItem("currentUser",JSON.stringify(l)),sessionStorage.setItem("currentUser",JSON.stringify(l)),console.log("handleGoogleRedirect: 이미 변환된 사용자 객체 저장:",l.email),{success:!0,user:l}}const o=await u(e.uid),s=g(e,o?.gameData);try{localStorage.setItem("currentUser",JSON.stringify(s)),sessionStorage.setItem("currentUser",JSON.stringify(s));const l=localStorage.getItem("currentUser");if(!l)console.error("handleGoogleRedirect: localStorage 저장 실패!");else{const m=JSON.parse(l);console.log("handleGoogleRedirect: Google 로그인 성공 - 사용자 저장됨:",s.email,"저장 확인:",!!l,"저장된 ID:",m.id)}}catch(l){console.error("handleGoogleRedirect: 저장 오류:",l)}return{success:!0,user:s}}console.log("handleGoogleRedirect: 리다이렉트 결과 없음, Firebase 인증 상태 즉시 확인...");for(let e=0;e<10;e++){if(r&&r.currentUser){console.log(`handleGoogleRedirect: 재시도 ${e+1}회 후 Firebase 인증 상태 발견:`,r.currentUser.email),c=!0;const o=r.currentUser,s=await u(o.uid),l=g(o,s?.gameData);return localStorage.setItem("currentUser",JSON.stringify(l)),sessionStorage.setItem("currentUser",JSON.stringify(l)),console.log("handleGoogleRedirect: 재시도 후 Firebase 인증 상태 확인 - 사용자 저장됨:",l.email),{success:!0,user:l}}e<9&&await new Promise(o=>setTimeout(o,200))}return console.log("handleGoogleRedirect: 재시도 후에도 인증 상태 없음, onAuthStateChanged 대기 중..."),new Promise(e=>{let o=!1;if(!r){console.error("handleGoogleRedirect: Firebase Auth가 없습니다."),e({success:!1,error:"Firebase가 설정되지 않았습니다."});return}r.currentUser&&(async()=>{try{console.log("handleGoogleRedirect: Promise 내부에서 즉시 Firebase 인증 상태 발견:",r.currentUser.email),c=!0;const a=r.currentUser,i=await u(a.uid),n=g(a,i?.gameData);localStorage.setItem("currentUser",JSON.stringify(n)),sessionStorage.setItem("currentUser",JSON.stringify(n)),console.log("handleGoogleRedirect: Promise 내부에서 사용자 저장됨:",n.email),o||(o=!0,e({success:!0,user:n}))}catch(a){console.error("handleGoogleRedirect: Promise 내부 처리 오류:",a)}})();const s=setTimeout(()=>{o||(o=!0,console.log("handleGoogleRedirect: 인증 상태 변경 대기 시간 초과 (10초)"),r&&r.currentUser?(async()=>{try{c=!0;const a=r.currentUser,i=await u(a.uid),n=g(a,i?.gameData);localStorage.setItem("currentUser",JSON.stringify(n)),sessionStorage.setItem("currentUser",JSON.stringify(n)),console.log("handleGoogleRedirect: 타임아웃 후 Firebase 인증 상태 확인 - 사용자 저장됨:",n.email),e({success:!0,user:n})}catch(a){console.error("handleGoogleRedirect: 타임아웃 후 사용자 데이터 로드 오류:",a),e({success:!1,error:"인증 상태 확인 실패"})}})():(console.log("handleGoogleRedirect: 최종 확인: 인증 상태 없음"),e({success:!1,error:"리다이렉트 결과가 없고 인증 상태도 없습니다. 잠시 후 다시 시도해주세요."})))},1e4);let l=!0;const m=f(r,async a=>{if(l){l=!1,a?console.log("handleGoogleRedirect: onAuthStateChanged 초기 상태 - 사용자 있음:",a.email):console.log("handleGoogleRedirect: onAuthStateChanged 초기 상태 - 사용자 없음 (정상, 리다이렉트 대기 중)");return}if(a&&!o){o=!0,clearTimeout(s),m();try{console.log("handleGoogleRedirect: onAuthStateChanged 감지 - 사용자 발견:",a.email),c=!0;const i=await u(a.uid),n=g(a,i?.gameData);localStorage.setItem("currentUser",JSON.stringify(n)),sessionStorage.setItem("currentUser",JSON.stringify(n)),console.log("handleGoogleRedirect: onAuthStateChanged - 사용자 저장됨:",n.email),e({success:!0,user:n})}catch(i){console.error("handleGoogleRedirect: 인증 상태 변경 처리 오류:",i),e({success:!1,error:i.message})}}else!a&&!o&&console.log("handleGoogleRedirect: onAuthStateChanged - 사용자 로그아웃됨 (리다이렉트가 발생하지 않았을 수 있음)")})})}catch(t){if(console.error("리다이렉트 처리 오류:",t),r&&r.currentUser)try{console.log("에러 발생했지만 Firebase 인증 상태 있음:",r.currentUser.email),c=!0;const e=r.currentUser,o=await u(e.uid),s=g(e,o?.gameData);return localStorage.setItem("currentUser",JSON.stringify(s)),sessionStorage.setItem("currentUser",JSON.stringify(s)),console.log("Fallback 처리 - 사용자 저장됨:",s.email),{success:!0,user:s}}catch(e){console.error("Fallback 처리 오류:",e)}return{success:!1,error:t.message}}finally{d=null}})(),d};export{g as convertFirebaseUserToAppUser,S as handleGoogleRedirect};
